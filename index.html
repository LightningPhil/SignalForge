<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal Forge</title>
    
    <!-- Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.3.0/math.min.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body>

    <div class="app-container">
        <header>
            <h1>Signal Forge</h1>
            <nav>
                <button id="btn-load-file">üìÇ Load</button>
                <button id="btn-view-grid">üìÖ Grid</button>
                <button id="btn-graph-config">‚öôÔ∏è Graph</button>
                <button id="btn-export">üíæ Export</button>
                <button id="btn-help">‚ùì Help</button>
                <button id="btn-theme-toggle" class="theme-toggle" aria-pressed="false" title="Toggle light or dark appearance">
                    <span class="theme-icon">üåô</span>
                    <span class="theme-label">Dark Mode</span>
                </button>
            </nav>
        </header>

        <main>
            <!-- Sidebar -->
            <aside class="controls">
                
                <div class="panel">
                    <h3>Filter Pipeline</h3>
                    <div class="checkbox-row" style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
                        <label for="chk-sync-tabs" class="toggle-label" style="margin:0;">
                            <input type="checkbox" id="chk-sync-tabs" checked>
                            Sync All Tabs
                        </label>
                        <small style="color:#aaa;">Apply this pipeline across every tab.</small>
                    </div>
                    <div id="pipeline-list"></div>
                    <div class="pipeline-actions">
                        <button id="btn-add-step" title="Add Step">‚ûï Add</button>
                        <button id="btn-remove-step" title="Remove Step">üóëÔ∏è</button>
                        <button id="btn-move-up" title="Move Up">‚¨ÜÔ∏è</button>
                        <button id="btn-move-down" title="Move Down">‚¨áÔ∏è</button>
                    </div>
                    <div id="math-trace-note" class="hint" style="display:none; margin-top:8px;">
                        Math traces don‚Äôt have their own filter pipeline. Apply filtering in the source waveform tab(s) first.
                    </div>
                </div>

                <div class="panel" id="trace-selector-panel" style="display:none;">
                    <h3>Trace Selector</h3>
                    <p>Select which columns to display in this multi-view tab.</p>
                    <div id="trace-selector-list" class="checkbox-column"></div>
                </div>

                <div class="panel" id="param-editor">
                    <h3>Parameters</h3>
                    <div class="step-type-label" id="step-type-display">Select a step</div>
                    
                    <div id="filter-params">
                        
                        <!-- Window Size -->
                        <div id="group-window">
                            <label for="param-window">Window / Kernel</label>
                            <input type="number" id="param-window" value="5" min="1" step="2">
                            <div class="slider-group">
                                <input type="range" id="slider-window" min="1" max="101" step="2">
                            </div>
                            <small class="hint">Odd numbers only</small>
                        </div>

                        <!-- Polynomial Order -->
                        <div id="group-poly" style="display:none;">
                            <label for="param-poly">Poly Order</label>
                            <input type="number" id="param-poly" value="3" min="1" max="10">
                            <div class="slider-group">
                                <input type="range" id="slider-poly" min="1" max="6" step="1">
                            </div>
                        </div>

                        <!-- Iterations -->
                        <div id="group-iters" style="display:none;">
                            <label for="param-iters">Iterations</label>
                            <input type="number" id="param-iters" value="1" min="1" max="16">
                            <div class="slider-group">
                                <input type="range" id="slider-iters" min="1" max="16" step="1">
                            </div>
                        </div>

                        <!-- Alpha -->
                        <div id="group-alpha" style="display:none;">
                            <label for="param-alpha">Alpha</label>
                            <input type="number" id="param-alpha" value="0.1" min="0.001" max="1.0" step="0.01">
                            <div class="slider-group">
                                <input type="range" id="slider-alpha" min="0.001" max="1.0" step="0.001">
                            </div>
                        </div>

                        <!-- Sigma -->
                        <div id="group-sigma" style="display:none;">
                            <label for="param-sigma">Sigma</label>
                            <input type="number" id="param-sigma" value="1.0" min="0.1" step="0.1">
                            <div class="slider-group">
                                <input type="range" id="slider-sigma" min="0.1" max="20.0" step="0.1">
                            </div>
                        </div>

                        <!-- Decay Length -->
                        <div id="group-decay" style="display:none;">
                            <div class="checkbox-row" style="display:flex; gap:10px; margin-bottom:10px;">
                                <label style="display:flex; align-items:center; gap:6px;">
                                    <input type="checkbox" id="param-apply-start" checked>
                                    Apply Start Taper
                                </label>
                                <label style="display:flex; align-items:center; gap:6px;">
                                    <input type="checkbox" id="param-apply-end" checked>
                                    Apply End Taper
                                </label>
                            </div>

                            <label for="param-start-decay">Start Fade Length</label>
                            <input type="number" id="param-start-decay" value="50" min="0">
                            <div class="slider-group">
                                <input type="range" id="slider-start-decay" min="0" max="500" step="1">
                            </div>

                            <label for="param-end-decay">End Fade Length</label>
                            <input type="number" id="param-end-decay" value="50" min="0">
                            <div class="slider-group">
                                <input type="range" id="slider-end-decay" min="0" max="500" step="1">
                            </div>

                            <label for="param-start-offset">Start Offset</label>
                            <input type="number" id="param-start-offset" value="0" step="0.000001">

                            <div class="auto-offset-group">
                                <label class="toggle-label" for="param-auto-offset">
                                    <input type="checkbox" id="param-auto-offset">
                                    Auto Start Offset
                                </label>
                                <label for="param-offset-points">Auto Offset Sample Count</label>
                                <input type="number" id="param-offset-points" value="200" min="1">
                            </div>
                            <small class="hint">Automatically averages the first N points when enabled.</small>
                        </div>

                        <!-- Frequency Domain (No sliders for huge ranges usually) -->
                        <div id="group-freq" style="display:none;">
                            <label for="param-freq">Cutoff Frequency</label>
                            <div class="input-with-unit">
                                <input type="number" id="param-freq" value="100" min="0.1" step="0.1">
                                <select id="unit-freq">
                                    <option value="1">Hz</option>
                                    <option value="1000">kHz</option>
                                    <option value="1000000" selected>MHz</option>
                                    <option value="1000000000">GHz</option>
                                </select>
                            </div>
                        </div>

                        <div id="group-slope" style="display:none;">
                            <label for="param-slope">Slope (dB/Octave)</label>
                            <input type="number" id="param-slope" value="12" min="6" step="6">
                            <div class="slider-group">
                                <input type="range" id="slider-slope" min="6" max="96" step="6">
                            </div>
                        </div>

                        <div id="group-q" style="display:none;">
                            <label for="param-q">Q Factor</label>
                            <input type="number" id="param-q" value="0.707" min="0.1" step="0.01">
                            <div class="slider-group">
                                <input type="range" id="slider-q" min="0.1" max="10.0" step="0.1">
                            </div>
                        </div>

                        <div id="group-bw" style="display:none;">
                            <label for="param-bw">Bandwidth</label>
                            <div class="input-with-unit">
                                <input type="number" id="param-bw" value="1" min="0.1" step="0.1">
                                <select id="unit-bw">
                                    <option value="1">Hz</option>
                                    <option value="1000">kHz</option>
                                    <option value="1000000" selected>MHz</option>
                                    <option value="1000000000">GHz</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="panel" id="measurement-panel">
                    <div class="panel-header">
                        <h3>Measurements</h3>
                        <div class="preset-control">
                            <label for="measurement-preset">Preset</label>
                            <select id="measurement-preset"></select>
                        </div>
                    </div>
                    <div class="measurement-meta">
                        <div>
                            <div class="label">Trace</div>
                            <div id="measurement-trace" class="value">No trace selected</div>
                        </div>
                        <div>
                            <div class="label">Selection</div>
                            <div id="measurement-selection" class="value">Full record</div>
                        </div>
                    </div>
                    <div class="measurement-table-wrapper">
                        <table class="measurement-table">
                            <tbody id="measurement-rows"></tbody>
                        </table>
                        <div id="measurement-summary" class="measurement-summary"></div>
                    </div>
                    <ul id="measurement-warnings" class="measurement-warnings"></ul>
                </div>

                <div class="panel" id="spectral-panel">
                    <h3>FFT / Spectrum</h3>
                    <div class="fft-controls">
                        <div class="fft-row">
                            <label for="fft-window">Window</label>
                            <select id="fft-window">
                                <option value="hann">Hann</option>
                                <option value="hamming">Hamming</option>
                                <option value="blackman">Blackman</option>
                                <option value="blackman-harris">Blackman-Harris</option>
                                <option value="flattop">Flattop</option>
                                <option value="kaiser">Kaiser</option>
                                <option value="rectangular">Rectangular</option>
                            </select>
                        </div>
                        <div class="fft-row">
                            <label for="fft-detrend">Detrend</label>
                            <select id="fft-detrend">
                                <option value="removeMean">Remove mean</option>
                                <option value="linear">Remove linear</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="fft-row split">
                            <label for="fft-zero-pad">Zero pad</label>
                            <select id="fft-zero-pad">
                                <option value="nextPow2">Next pow2</option>
                                <option value="factor">Factor</option>
                                <option value="none">Off</option>
                            </select>
                            <input type="number" id="fft-zero-factor" min="1" step="1" value="2" title="Zero pad factor">
                        </div>
                        <div class="fft-row split">
                            <label for="fft-view">View</label>
                            <select id="fft-view">
                                <option value="magnitude">Magnitude</option>
                                <option value="phase">Phase</option>
                                <option value="both">Both</option>
                            </select>
                            <label for="fft-source">Source</label>
                            <select id="fft-source">
                                <option value="auto">Auto</option>
                                <option value="raw">Raw</option>
                                <option value="filtered">Filtered</option>
                            </select>
                        </div>
                        <div class="fft-row split">
                            <label for="fft-peak-count">Peaks</label>
                            <input type="number" id="fft-peak-count" min="1" max="20" value="5">
                            <label for="fft-peak-prominence">Prominence</label>
                            <input type="number" id="fft-peak-prominence" min="0" step="0.001" value="0.02">
                        </div>
                        <div class="fft-row split">
                            <label class="inline-label">
                                <input type="checkbox" id="fft-show-harmonics"> Harmonics
                            </label>
                            <label for="fft-harmonic-count">Count</label>
                            <input type="number" id="fft-harmonic-count" min="1" max="12" value="5">
                        </div>
                        <div class="fft-row">
                            <label for="fft-fundamental">Fundamental (Hz)</label>
                            <input type="number" id="fft-fundamental" step="0.001" placeholder="Auto from peak">
                        </div>
                    </div>
                    <div class="fft-summary" id="fft-meta">Load data to view spectrum</div>
                    <ul id="fft-warnings" class="measurement-warnings"></ul>
                    <div class="fft-section">
                        <h4>Peaks</h4>
                        <table id="fft-peaks-table" class="simple-table"></table>
                    </div>
                    <div class="fft-section">
                        <h4>Metrics</h4>
                        <table id="fft-metrics-table" class="simple-table"></table>
                    </div>
                </div>

                <div class="panel" id="system-panel">
                    <div class="panel-header">
                        <h3>System / Bode</h3>
                    </div>
                    <div class="system-grid">
                        <label for="system-input">Input</label>
                        <select id="system-input"></select>

                        <label for="system-output">Output</label>
                        <select id="system-output"></select>

                        <label for="system-use-selection" class="inline">
                            <input type="checkbox" id="system-use-selection" checked>
                            Selection only
                        </label>
                        <label for="system-max-lag">Max lag (s)</label>
                        <input type="number" id="system-max-lag" step="0.000001" min="0" placeholder="Auto">
                    </div>
                    <div id="system-summary" class="system-summary">Select input/output channels to compute FRF.</div>
                    <ul id="system-warnings" class="measurement-warnings"></ul>
                </div>

                <div class="panel" id="events-panel">
                    <div class="panel-header">
                        <h3>Events</h3>
                        <div id="event-count" class="event-count">0 events</div>
                    </div>
                    <div class="event-controls">
                        <div class="event-row">
                            <label for="event-type">Type</label>
                            <select id="event-type">
                                <option value="level">Level</option>
                                <option value="edge">Edge</option>
                                <option value="pulse">Pulse Width</option>
                                <option value="runt">Runt</option>
                            </select>
                        </div>
                        <div class="event-row">
                            <label for="event-direction">Direction</label>
                            <select id="event-direction">
                                <option value="rising">Rising</option>
                                <option value="falling">Falling</option>
                                <option value="either">Either</option>
                            </select>
                        </div>
                        <div class="event-row">
                            <label for="event-source">Source</label>
                            <select id="event-source">
                                <option value="auto">Auto</option>
                                <option value="raw">Raw</option>
                                <option value="filtered">Filtered</option>
                                <option value="math">Math</option>
                            </select>
                        </div>
                        <div class="event-grid">
                            <label for="event-threshold">Threshold</label>
                            <input type="number" id="event-threshold" step="0.001" value="0">
                            <label for="event-hysteresis">Hysteresis</label>
                            <input type="number" id="event-hysteresis" step="0.001" value="0">
                            <label for="event-slope">Slope Threshold</label>
                            <input type="number" id="event-slope" step="0.001" value="0">
                            <label for="event-min-width">Min Width (s)</label>
                            <input type="number" id="event-min-width" step="0.000001" value="0">
                            <label for="event-max-width">Max Width (s)</label>
                            <input type="number" id="event-max-width" step="0.000001" value="1">
                            <label for="event-high-threshold">High (runt)</label>
                            <input type="number" id="event-high-threshold" step="0.001" value="1">
                            <label for="event-low-threshold">Low (runt)</label>
                            <input type="number" id="event-low-threshold" step="0.001" value="0">
                        </div>
                        <label class="toggle-label" for="event-use-selection">
                            <input type="checkbox" id="event-use-selection" checked>
                            Limit to selection
                        </label>
                    </div>
                    <ul id="event-warnings" class="measurement-warnings"></ul>
                    <div id="event-list" class="event-list"></div>
                </div>

                <div class="panel" id="composer-panel" style="display:none;">
                    <h3>Jitter Correction</h3>
                    <div id="composer-list" class="composer-list"></div>
                </div>
            </aside>

            <section class="graph-container">
                <div id="tabs-wrapper" class="tabs-wrapper">
                    <div class="tabs-row">
                        <div id="tabs-scroll-viewport" class="tabs-viewport" aria-label="Trace tabs">
                            <div id="column-tabs" class="tabs-strip">
                                <div class="tab-placeholder">Load data to see columns</div>
                            </div>
                        </div>

                        <button
                            id="btn-add-multiview"
                            class="tabs-add"
                            title="Add Multi-View or Math Trace"
                            aria-label="Add Multi-View or Math Trace"
                            type="button"
                        >+</button>
                    </div>

                    <div id="tabs-scrollbar" class="tabs-scrollbar" aria-hidden="true">
                        <div id="tabs-scrollbar-spacer" class="tabs-scrollbar-spacer"></div>
                    </div>

                    <div class="tabs-scrollbar-filler" aria-hidden="true"></div>
                </div>

                <div class="graph-toolbar">
                    <div class="tool-group">
                        <label class="toggle-label"><input type="checkbox" id="live-show-raw" checked> Raw</label>
                    </div>
                    <div class="tool-group" id="container-opacity">
                        <label>Opacity</label>
                        <input type="range" id="live-raw-opacity" min="0" max="1" step="0.05" value="0.5">
                    </div>
                    <div class="tool-group tool-divider">
                        <label class="toggle-label"><input type="checkbox" id="live-show-diff"> Diff</label>
                    </div>
                    <div class="tool-group tool-divider">
                        <label for="live-view-mode">View</label>
                        <select id="live-view-mode">
                            <option value="time">Time</option>
                            <option value="fft">FFT</option>
                            <option value="spectrogram">Spectrogram</option>
                            <option value="bode">Bode</option>
                        </select>
                    </div>
                    <div class="tool-group tool-divider">
                        <label class="toggle-label"><input type="checkbox" id="live-show-events" checked> Events</label>
                    </div>
                    <div class="tool-group event-nav">
                        <button id="btn-event-prev" title="Previous event">‚óÄ</button>
                        <button id="btn-event-next" title="Next event">‚ñ∂</button>
                    </div>
                    <div class="tool-item" style="margin-left: auto;">
                        <span id="live-status" style="font-size: 0.8em; color: var(--text-muted);">Ready</span>
                    </div>
                </div>

                <div id="main-plot"></div>
            </section>
        </main>
    </div>

    <input type="file" id="file-input" accept=".csv,.txt" style="display: none;">
    <script type="module" src="src/main.js"></script>
</body>
</html>
